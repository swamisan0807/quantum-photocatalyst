<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>Advanced Quantum Photocatalyst Simulator</title>
  <style>
    :root {
      --bg1: #0a0e1a; --bg2: #0f1524; --panel: #1a2332; 
      --accent1: #00d8ff; --accent2: #ff00d4; --accent3: #00ff88;
      --text: #e6f4ff; --text-muted: #8fa5c0;
    }
    * { margin: 0; padding: 0; box-sizing: border-box; }
    body {
      font-family: 'Inter', -apple-system, BlinkMacSystemFont, 'Segoe UI', sans-serif;
      background: linear-gradient(135deg, #0a0e1a 0%, #0f1829 50%, #0a1220 100%);
      color: var(--text);
      min-height: 100vh;
      line-height: 1.6;
    }
    .grid-bg {
      position: fixed; inset: 0;
      background-image: 
        radial-gradient(circle at 20% 50%, rgba(0,216,255,0.03) 0%, transparent 50%),
        radial-gradient(circle at 80% 80%, rgba(255,0,212,0.03) 0%, transparent 50%),
        linear-gradient(rgba(255,255,255,0.02) 1px, transparent 1px),
        linear-gradient(90deg, rgba(255,255,255,0.02) 1px, transparent 1px);
      background-size: 100% 100%, 100% 100%, 50px 50px, 50px 50px;
      z-index: -1;
    }
    
    header { 
      padding: 32px 24px 24px; 
      text-align: center;
      background: linear-gradient(180deg, rgba(26,35,50,0.4) 0%, transparent 100%);
      border-bottom: 1px solid rgba(0,216,255,0.1);
    }
    h1 {
      font-size: 36px; font-weight: 800; margin-bottom: 8px;
      background: linear-gradient(135deg, var(--accent1) 0%, var(--accent2) 100%);
      -webkit-background-clip: text; -webkit-text-fill-color: transparent;
      letter-spacing: 0.5px;
    }
    .subtitle { 
      color: var(--text-muted); 
      font-size: 15px; 
      margin-bottom: 20px;
    }
    .stats-bar {
      display: flex; justify-content: center; gap: 16px; 
      margin-top: 20px; flex-wrap: wrap;
    }
    .stat-item {
      background: linear-gradient(135deg, rgba(0,216,255,0.08) 0%, rgba(0,216,255,0.03) 100%);
      padding: 12px 24px; border-radius: 12px;
      border: 1px solid rgba(0,216,255,0.2);
      box-shadow: 0 4px 15px rgba(0,0,0,0.3);
      transition: all 0.3s ease;
    }
    .stat-item:hover {
      transform: translateY(-2px);
      box-shadow: 0 6px 20px rgba(0,216,255,0.2);
    }
    .stat-value { 
      font-size: 24px; font-weight: 700; 
      color: var(--accent1);
      text-shadow: 0 0 10px rgba(0,216,255,0.3);
    }
    .stat-label { 
      font-size: 11px; 
      color: var(--text-muted); 
      margin-top: 2px; 
      text-transform: uppercase;
      letter-spacing: 0.5px;
    }
    
    .container {
      max-width: 1600px; 
      margin: 0 auto; 
      padding: 24px 20px;
      display: grid; 
      grid-template-columns: 420px 1fr; 
      gap: 24px;
    }
    
    .panel {
      background: linear-gradient(135deg, rgba(26,35,50,0.95) 0%, rgba(15,21,36,0.95) 100%);
      border-radius: 16px; 
      padding: 24px;
      box-shadow: 0 8px 32px rgba(0,0,0,0.5);
      border: 1px solid rgba(0,216,255,0.1);
      backdrop-filter: blur(10px);
    }
    .panel h3 { 
      margin: 0 0 18px 0; 
      color: var(--accent1); 
      font-size: 18px;
      font-weight: 700;
      display: flex;
      align-items: center;
      gap: 8px;
    }
    
    label {
      display: block; 
      margin: 14px 0 8px; 
      color: var(--text); 
      font-weight: 600; 
      font-size: 13px;
    }
    label span {
      float: right;
      color: var(--accent1);
      font-weight: 700;
    }
    
    select, input[type="range"], input[type="number"] {
      width: 100%; 
      padding: 12px; 
      border-radius: 10px;
      border: 1px solid rgba(0,216,255,0.25);
      background: rgba(10,14,26,0.6);
      color: var(--text); 
      font-size: 14px;
      transition: all 0.3s ease;
    }
    select:focus, input:focus {
      outline: none;
      border-color: var(--accent1);
      box-shadow: 0 0 0 3px rgba(0,216,255,0.15);
    }
    select[multiple] {
      height: 110px; 
      padding: 8px;
      background: rgba(10,14,26,0.8);
    }
    select[multiple] option {
      padding: 8px 12px; 
      margin: 3px 0; 
      border-radius: 6px; 
      cursor: pointer;
      transition: all 0.2s ease;
    }
    select[multiple] option:hover {
      background: rgba(0,216,255,0.15);
    }
    select[multiple] option:checked {
      background: linear-gradient(90deg, rgba(0,216,255,0.35), rgba(255,0,212,0.35));
      font-weight: 600;
      color: #fff;
    }
    
    .btn {
      margin-top: 18px; 
      padding: 14px 20px; 
      border-radius: 12px; 
      border: none;
      width: 100%; 
      cursor: pointer; 
      font-weight: 700; 
      font-size: 15px;
      background: linear-gradient(135deg, var(--accent1) 0%, var(--accent2) 100%);
      color: #000; 
      box-shadow: 0 6px 20px rgba(0,216,255,0.3);
      transition: all 0.3s ease;
      text-transform: uppercase;
      letter-spacing: 0.5px;
    }
    .btn:hover { 
      transform: translateY(-3px);
      box-shadow: 0 10px 30px rgba(0,216,255,0.4);
    }
    .btn:disabled { 
      opacity: 0.5; 
      cursor: not-allowed; 
      transform: none;
    }
    
    .select-all-btn {
      font-size: 11px; 
      padding: 6px 14px;
      background: rgba(0,216,255,0.12);
      border: 1px solid rgba(0,216,255,0.3);
      border-radius: 6px; 
      color: var(--accent1); 
      cursor: pointer;
      margin-top: 8px; 
      margin-right: 8px;
      transition: all 0.2s ease;
      text-transform: uppercase;
      letter-spacing: 0.5px;
      font-weight: 600;
    }
    .select-all-btn:hover {
      background: rgba(0,216,255,0.25);
      transform: translateY(-1px);
    }
    
    .param-grid {
      display: grid; 
      grid-template-columns: 1fr; 
      gap: 10px; 
      margin: 12px 0;
    }
    
    .results-panel {
      display: grid;
      gap: 20px;
    }
    
    .circuit {
      min-height: 280px; 
      background: linear-gradient(135deg, rgba(10,14,26,0.6) 0%, rgba(15,21,36,0.6) 100%);
      border-radius: 12px;
      display: flex; 
      align-items: center; 
      justify-content: center;
      color: var(--text-muted); 
      padding: 20px;
      border: 1px solid rgba(0,216,255,0.15);
      box-shadow: inset 0 2px 10px rgba(0,0,0,0.3);
    }
    .circuit img { 
      max-width: 100%; 
      border-radius: 10px;
      box-shadow: 0 4px 15px rgba(0,0,0,0.3);
    }
    
    .results-box {
      margin-top: 16px;
      background: linear-gradient(135deg, rgba(26,35,50,0.6) 0%, rgba(15,21,36,0.6) 100%);
      padding: 20px;
      border-radius: 12px;
      border: 1px solid rgba(0,216,255,0.15);
      box-shadow: 0 4px 15px rgba(0,0,0,0.3);
    }
    .results-box > div {
      margin-bottom: 12px;
      font-size: 14px;
    }
    .results-box strong { 
      color: var(--accent1);
      font-weight: 600;
    }
    
    .metric-box {
      background: linear-gradient(135deg, rgba(0,216,255,0.08) 0%, rgba(0,216,255,0.03) 100%);
      padding: 16px;
      border-radius: 10px;
      margin: 12px 0;
      border-left: 4px solid var(--accent1);
      box-shadow: 0 2px 10px rgba(0,0,0,0.2);
    }
    .metric-box.degradation {
      background: linear-gradient(135deg, rgba(255,0,212,0.08) 0%, rgba(255,0,212,0.03) 100%);
      border-left-color: var(--accent2);
    }
    .metric-box h4 {
      font-weight: 700;
      margin-bottom: 10px;
      font-size: 14px;
      color: var(--text);
    }
    .metric-grid {
      display: grid; 
      grid-template-columns: 1fr 1fr;
      gap: 10px;
      font-size: 13px;
    }
    .metric-grid > div {
      background: rgba(0,0,0,0.2);
      padding: 8px 12px;
      border-radius: 6px;
    }
    
    .plot-section {
      margin-bottom: 20px;
    }
    .plot-section h3 {
      font-size: 16px;
      color: var(--accent1);
      margin-bottom: 12px;
      font-weight: 700;
    }
    .plot-container {
      min-height: 240px;
      background: linear-gradient(135deg, rgba(10,14,26,0.8) 0%, rgba(15,21,36,0.8) 100%);
      border-radius: 12px;
      display: flex;
      align-items: center;
      justify-content: center;
      border: 1px solid rgba(0,216,255,0.15);
      padding: 15px;
      box-shadow: inset 0 2px 10px rgba(0,0,0,0.3);
    }
    .plot-container img {
      max-width: 100%;
      border-radius: 8px;
    }
    
    .download-section {
      display: grid; 
      grid-template-columns: repeat(auto-fit, minmax(140px, 1fr));
      gap: 10px; 
      margin-top: 16px;
    }
    .download-btn {
      padding: 12px 16px;
      background: linear-gradient(135deg, rgba(42,63,95,0.8), rgba(26,47,79,0.8));
      border: 1px solid rgba(0,216,255,0.3);
      border-radius: 10px;
      color: var(--accent1); 
      cursor: pointer; 
      font-size: 12px; 
      font-weight: 600;
      text-align: center;
      transition: all 0.3s ease;
      box-shadow: 0 2px 10px rgba(0,0,0,0.3);
    }
    .download-btn:hover {
      background: linear-gradient(135deg, rgba(58,95,143,0.9), rgba(42,79,127,0.9));
      transform: translateY(-2px);
      box-shadow: 0 4px 15px rgba(0,216,255,0.3);
    }
    .download-btn.excel {
      background: linear-gradient(135deg, rgba(30,113,69,0.8), rgba(13,92,47,0.8));
      color: var(--accent3);
      border-color: rgba(0,255,136,0.3);
    }
    .download-btn.excel:hover {
      background: linear-gradient(135deg, rgba(46,145,85,0.9), rgba(29,124,79,0.9));
      box-shadow: 0 4px 15px rgba(0,255,136,0.3);
    }
    
    footer { 
      text-align: center; 
      color: var(--text-muted); 
      padding: 24px; 
      font-size: 13px;
      border-top: 1px solid rgba(0,216,255,0.1);
      margin-top: 20px;
    }
    
    @media(max-width: 1400px) {
      .container { 
        grid-template-columns: 380px 1fr; 
        gap: 20px;
      }
    }
    @media(max-width: 1024px) {
      .container { 
        grid-template-columns: 1fr;
        padding: 20px 16px;
      }
      .param-grid { 
        grid-template-columns: 1fr 1fr;
      }
    }
    @media(max-width: 640px) {
      .param-grid { 
        grid-template-columns: 1fr;
      }
      .download-section {
        grid-template-columns: 1fr 1fr;
      }
      h1 { font-size: 28px; }
    }
  </style>
</head>
<body>
  <div class="grid-bg"></div>
  
  <header>
    <h1>⚛️ Quantum Photocatalyst Simulator</h1>
    <div class="subtitle">Advanced nanomaterial analysis • UV-Vis spectroscopy • Optical bandgap • Degradation kinetics</div>
    <div class="stats-bar">
      <div class="stat-item">
        <div class="stat-value">200+</div>
        <div class="stat-label">Materials</div>
      </div>
      <div class="stat-item">
        <div class="stat-value" id="catCount">1</div>
        <div class="stat-label">Catalysts</div>
      </div>
      <div class="stat-item">
        <div class="stat-value" id="dyeCount">1</div>
        <div class="stat-label">Dyes</div>
      </div>
      <div class="stat-item">
        <div class="stat-value" id="qubitCount">15</div>
        <div class="stat-label">Qubits</div>
      </div>
    </div>
  </header>

  <main class="container">
    <!-- Left Panel: Configuration -->
    <section class="panel">
      <h3>🧪 Configuration</h3>

      <label>🎨 Target Dyes</label>
      <select id="dyeType" multiple>
        <option value="MethyleneBlue" selected>Methylene Blue</option>
        <option value="RhodamineB">Rhodamine B</option>
        <option value="MethylOrange">Methyl Orange</option>
        <option value="CrystalViolet">Crystal Violet</option>
        <option value="CongoRed">Congo Red</option>
        <option value="MalachiteGreen">Malachite Green</option>
      </select>
      <button class="select-all-btn" onclick="selectAll('dyeType')">All</button>
      <button class="select-all-btn" onclick="clearAll('dyeType')">Clear</button>

      <label>⚗️ Photocatalyst Systems</label>
      <select id="materialType" multiple>
        <optgroup label="Metal Oxides">
          <option value="TiO2" selected>TiO₂</option>
          <option value="ZnO">ZnO</option>
          <option value="WO3">WO₃</option>
          <option value="BiVO4">BiVO₄</option>
          <option value="CdS">CdS</option>
          <option value="Ag3PO4">Ag₃PO₄</option>
        </optgroup>
        <optgroup label="Carbon Systems">
          <option value="gC3N4">g-C₃N₄</option>
          <option value="CNT">CNT</option>
          <option value="Graphene">Graphene</option>
          <option value="RGO">RGO</option>
        </optgroup>
        <optgroup label="CNT-Doped">
          <option value="CNT-AgNPs">CNT-AgNPs</option>
          <option value="CNT-Ag-Zn-BMNPs">CNT-Ag-Zn BMNPs</option>
          <option value="CNT-Ni-Co-Fe">CNT-Ni-Co-Fe</option>
        </optgroup>
        <optgroup label="BMNPs">
          <option value="Ag-Au-BMNPs">Ag-Au BMNPs</option>
          <option value="Pt-Pd-BMNPs">Pt-Pd BMNPs</option>
          <option value="Cu-Ni-BMNPs">Cu-Ni BMNPs</option>
        </optgroup>
        <optgroup label="TMNCs">
          <option value="RGO-TMNCs">RGO-TMNCs</option>
          <option value="CNT-TMNCs">CNT-TMNCs</option>
          <option value="Polymer-TMNCs">Polymer TMNCs</option>
        </optgroup>
      </select>
      <button class="select-all-btn" onclick="selectAll('materialType')">All</button>
      <button class="select-all-btn" onclick="clearAll('materialType')">Clear</button>

      <div class="param-grid">
        <div>
          <label>Dye Conc. <span id="dyeConcVal">20 ppm</span></label>
          <input id="dyeConc" type="range" min="1" max="100" value="20">
        </div>
        <div>
          <label>Add Variant (ppm)</label>
          <input id="dyeConcVariant" type="number" placeholder="e.g., 50">
        </div>
        <div>
          <label>Catalyst Conc. <span id="catConcVal">5 mg</span></label>
          <input id="catConc" type="range" min="1" max="10" step="0.5" value="5">
        </div>
        <div>
          <label>Particle Size <span id="catSizeVal">50 nm</span></label>
          <input id="catSize" type="range" min="10" max="100" step="5" value="50">
        </div>
        <div>
          <label>pH <span id="phVal">7.0</span></label>
          <input id="pH" type="range" min="1" max="14" step="0.5" value="7">
        </div>
        <div>
          <label>Stirring <span id="stirVal">500 rpm</span></label>
          <input id="stirring" type="range" min="200" max="800" step="50" value="500">
        </div>
        <div>
          <label>Temp <span id="tempVal">25 °C</span></label>
          <input id="temp" type="range" min="10" max="100" step="5" value="25">
        </div>
        <div>
          <label>Light <span id="lightVal">35 W</span></label>
          <input id="lightInt" type="range" min="20" max="50" step="5" value="35">
        </div>
      </div>

      <label>Light Source</label>
      <select id="lightSource">
        <option value="UV" selected>UV Light</option>
        <option value="LED-White">White LED</option>
        <option value="LED-Blue">Blue LED</option>
        <option value="Visible">Visible Light</option>
        <option value="Sunlight">Sunlight</option>
      </select>

      <label>Simulation Depth</label>
      <select id="circuitDepth">
        <option value="2">Level 2 – Fast (6 qubits)</option>
        <option value="3">Level 3 – Balanced (10 qubits)</option>
        <option value="4" selected>Level 4 – Deep (15 qubits)</option>
        <option value="5">Level 5 – Maximum (20 qubits)</option>
      </select>

      <button id="optimizeBtn" class="btn">🚀 Run Simulation</button>
    </section>

    <!-- Right Panel: Results -->
    <div class="results-panel">
      <section class="panel">
        <h3>⚛️ Quantum Circuit</h3>
        <div id="circuitContainer" class="circuit">
          <div style="text-align:center;color:var(--text-muted)">
            <div style="font-size:48px;margin-bottom:10px">⚛️</div>
            <div>Configure parameters and run simulation</div>
          </div>
        </div>

        <div id="resultBox" class="results-box" style="display:none"></div>

        <div id="downloadSection" class="download-section" style="display:none"></div>
      </section>

      <div id="plotsSection" style="display:none">
        <section class="panel plot-section">
          <h3>📊 UV-Vis Absorption Spectrum</h3>
          <div id="absContainer" class="plot-container"></div>
        </section>

        <section class="panel plot-section">
          <h3>📈 Tauc Plot (Optical Bandgap)</h3>
          <div id="taucContainer" class="plot-container"></div>
        </section>

        <section class="panel plot-section">
          <h3>📉 Degradation Kinetics</h3>
          <div id="degradContainer" class="plot-container"></div>
        </section>
      </div>
    </div>
  </main>

  <footer>⚡ Advanced Quantum Photocatalyst Simulator v4.0 • Complete Analysis Suite</footer>

  <script>
    let lastResults = null;
    const ranges = {
      dyeConc: document.getElementById('dyeConc'),
      catConc: document.getElementById('catConc'),
      catSize: document.getElementById('catSize'),
      pH: document.getElementById('pH'),
      stirring: document.getElementById('stirring'),
      temp: document.getElementById('temp'),
      lightInt: document.getElementById('lightInt')
    };

    ranges.dyeConc.oninput = () => document.getElementById('dyeConcVal').textContent = ranges.dyeConc.value + ' ppm';
    ranges.catConc.oninput = () => document.getElementById('catConcVal').textContent = ranges.catConc.value + ' mg';
    ranges.catSize.oninput = () => document.getElementById('catSizeVal').textContent = ranges.catSize.value + ' nm';
    ranges.pH.oninput = () => document.getElementById('phVal').textContent = ranges.pH.value;
    ranges.stirring.oninput = () => document.getElementById('stirVal').textContent = ranges.stirring.value + ' rpm';
    ranges.temp.oninput = () => document.getElementById('tempVal').textContent = ranges.temp.value + ' °C';
    ranges.lightInt.oninput = () => document.getElementById('lightVal').textContent = ranges.lightInt.value + ' W';

    document.getElementById('materialType').onchange = function() {
      document.getElementById('catCount').textContent = this.selectedOptions.length;
    };
    document.getElementById('dyeType').onchange = function() {
      document.getElementById('dyeCount').textContent = this.selectedOptions.length;
    };
    document.getElementById('circuitDepth').onchange = function() {
      const map = {2: 6, 3: 10, 4: 15, 5: 20};
      document.getElementById('qubitCount').textContent = map[parseInt(this.value)] || 15;
    };

    function selectAll(id) {
      Array.from(document.getElementById(id).options).forEach(o => o.selected = true);
      document.getElementById(id).onchange();
    }
    function clearAll(id) {
      Array.from(document.getElementById(id).options).forEach(o => o.selected = false);
      document.getElementById(id).onchange();
    }

    document.getElementById('optimizeBtn').onclick = async function() {
      const materials = Array.from(document.getElementById('materialType').selectedOptions).map(o => o.value);
      const dyes = Array.from(document.getElementById('dyeType').selectedOptions).map(o => o.value);
      
      if (!materials.length || !dyes.length) {
        alert('⚠️ Select at least one catalyst and one dye!');
        return;
      }

      const concentrations = [parseFloat(ranges.dyeConc.value)];
      const variant = document.getElementById('dyeConcVariant').value;
      if (variant) concentrations.push(parseFloat(variant));

      const params = {
        materials, dyes, dyeConcentrations: concentrations,
        catalystConcentration: parseFloat(ranges.catConc.value),
        catalystSize: parseFloat(ranges.catSize.value),
        pH: parseFloat(ranges.pH.value),
        stirringSpeed: parseFloat(ranges.stirring.value),
        temperature: parseFloat(ranges.temp.value),
        lightSource: document.getElementById('lightSource').value,
        lightIntensity: parseFloat(ranges.lightInt.value),
        circuitDepth: parseInt(document.getElementById('circuitDepth').value)
      };

      const btn = this;
      btn.textContent = '⚙️ Simulating...';
      btn.disabled = true;

      try {
        const res = await fetch('/optimize', {
          method: 'POST',
          headers: {'Content-Type': 'application/json'},
          body: JSON.stringify(params)
        });
        const data = await res.json();
        
        btn.textContent = '🚀 Run Simulation';
        btn.disabled = false;

        if (!data.success) {
          alert('Error: ' + (data.error || 'unknown'));
          return;
        }

        lastResults = data;

        document.getElementById('circuitContainer').innerHTML = 
          `<img src="data:image/png;base64,${data.circuit_image}">`;
        
        document.getElementById('absContainer').innerHTML = 
          `<img src="data:image/png;base64,${data.absorption_plot}">`;
        document.getElementById('taucContainer').innerHTML = 
          `<img src="data:image/png;base64,${data.tauc_plot}">`;
        document.getElementById('degradContainer').innerHTML = 
          `<img src="data:image/png;base64,${data.degradation_plot}">`;

        document.getElementById('plotsSection').style.display = 'block';

        const box = document.getElementById('resultBox');
        box.style.display = 'block';
        box.innerHTML = `
          <div><strong>Materials:</strong> ${data.materials.join(', ')}</div>
          <div><strong>Dyes:</strong> ${data.dyes.join(', ')}</div>
          
          <div class="metric-box">
            <h4>📊 Optical Properties</h4>
            <div class="metric-grid">
              <div>Bandgap: <strong>${data.optimized_params.bandgap.toFixed(2)} eV</strong></div>
              <div>Optical Gap: <strong>${data.optical_bandgap.toFixed(2)} eV</strong></div>
              <div>Absorption: <strong>${data.optimized_params.absorption.toFixed(1)}%</strong></div>
              <div>Quantum Yield: <strong>${data.optimized_params.quantum_yield.toFixed(1)}%</strong></div>
            </div>
          </div>
          
          <div class="metric-box degradation">
            <h4>🔬 Degradation Performance</h4>
            <div class="metric-grid">
              <div>Degradation: <strong>${data.dye_degradation.toFixed(1)}%</strong></div>
              <div>Time: <strong>${data.reaction_time} min</strong></div>
              <div>Efficiency: <strong>${data.optimized_params.efficiency.toFixed(1)}%</strong></div>
              <div>Yield: <strong>${data.yield_percentage.toFixed(1)}%</strong></div>
            </div>
          </div>
          
          <p style="margin-top:12px;color:var(--text-muted);font-size:13px;line-height:1.6;font-style:italic">
            ${data.analysis}
          </p>
        `;

        const downloadSection = document.getElementById('downloadSection');
        downloadSection.style.display = 'grid';
        downloadSection.innerHTML = `
          <button class="download-btn" onclick="download('json')">📥 JSON</button>
          <button class="download-btn" onclick="download('circuit')">🖼️ Circuit</button>
          <button class="download-btn" onclick="download('absorption')">📊 Absorption</button>
          <button class="download-btn" onclick="download('tauc')">📈 Tauc</button>
          <button class="download-btn" onclick="download('kinetics')">📉 Kinetics</button>
          <button class="download-btn excel" onclick="download('excel')">📊 Excel</button>
          <button class="download-btn" onclick="download('report')">📄 Report</button>
        `;

      } catch (err) {
        btn.textContent = '🚀 Run Simulation';
        btn.disabled = false;
        alert('❌ Error: ' + err);
      }
    };

    async function download(type) {
      if (!lastResults) { alert('No results available'); return; }
      
      if (type === 'excel') {
        const res = await fetch('/download/excel', {
          method: 'POST',
          headers: {'Content-Type': 'application/json'},
          body: JSON.stringify(lastResults)
        });
        const blob = await res.blob();
        const a = document.createElement('a');
        a.href = URL.createObjectURL(blob);
        a.download = `photocatalyst_report_${Date.now()}.xlsx`;
        a.click();
      } else if (type === 'json') {
        const blob = new Blob([JSON.stringify(lastResults, null, 2)], {type: 'application/json'});
        const a = document.createElement('a');
        a.href = URL.createObjectURL(blob);
        a.download = `simulation_data_${Date.now()}.json`;
        a.click();
      } else if (['circuit', 'absorption', 'tauc', 'kinetics'].includes(type)) {
        const imgMap = {
          circuit: lastResults.circuit_image,
          absorption: lastResults.absorption_plot,
          tauc: lastResults.tauc_plot,
          kinetics: lastResults.degradation_plot
        };
        const a = document.createElement('a');
        a.href = `data:image/png;base64,${imgMap[type]}`;
        a.download = `${type}_plot_${Date.now()}.png`;
        a.click();
      } else if (type === 'report') {
        const r = lastResults;
        const report = `ADVANCED PHOTOCATALYST ANALYSIS REPORT
${'='.repeat(70)}
Generated: ${new Date().toLocaleString()}

CATALYST CONFIGURATION
${'-'.repeat(70)}
Materials: ${r.materials.join(', ')}
Catalyst Concentration: ${r.catalyst_concentration} mg
Particle Size: ${r.catalyst_size} nm

TARGET DYES
${'-'.repeat(70)}
Dyes: ${r.dyes.join(', ')}
Concentrations: ${r.dyeConcentrations?.join(', ') || r.dye_concentration} ppm

REACTION CONDITIONS
${'-'.repeat(70)}
pH: ${r.pH}
Temperature: ${r.temperature} °C
Stirring Speed: ${r.stirring_speed} rpm
Light Source: ${r.light_source}
Light Intensity: ${r.light_intensity} W

QUANTUM SIMULATION
${'-'.repeat(70)}
Number of Qubits: ${r.num_qubits}
Circuit Depth: Level ${r.circuit_depth}
Final Ground State Energy: ${r.final_energy.toFixed(6)}

OPTICAL PROPERTIES
${'-'.repeat(70)}
Material Bandgap: ${r.optimized_params.bandgap.toFixed(2)} eV
Optical Bandgap (Tauc): ${r.optical_bandgap.toFixed(2)} eV
Absorption: ${r.optimized_params.absorption.toFixed(2)}%
Quantum Yield: ${r.optimized_params.quantum_yield.toFixed(2)}%

DEGRADATION PERFORMANCE
${'-'.repeat(70)}
Dye Degradation: ${r.dye_degradation.toFixed(2)}%
Reaction Time: ${r.reaction_time} minutes
Photocatalytic Efficiency: ${r.optimized_params.efficiency.toFixed(2)}%
Process Yield: ${r.yield_percentage.toFixed(2)}%

ANALYSIS
${'-'.repeat(70)}
${r.analysis}

EXPERIMENTAL VALIDATION NOTES
${'-'.repeat(70)}
UV-Vis Absorption Peak: ${(1240 / r.optimized_params.bandgap).toFixed(0)} nm
Particle Size Effect: Quantum confinement observed at ${r.catalyst_size} nm
Recommended Synthesis: ${r.materials.join(' + ')} composite
Application: Water purification and dye degradation

${'='.repeat(70)}
Report generated by Advanced Quantum Photocatalyst Simulator v4.0
Powered by Qiskit Quantum Computing Framework
`;
        const blob = new Blob([report], {type: 'text/plain'});
        const a = document.createElement('a');
        a.href = URL.createObjectURL(blob);
        a.download = `analysis_report_${Date.now()}.txt`;
        a.click();
      }
    }
  </script>
</body>
</html>
